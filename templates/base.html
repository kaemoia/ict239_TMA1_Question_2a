<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}E-Library{% endblock %}</title>
    <!-- External CSS libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% block styles %}{% endblock %} <!-- Block for page-specific styles -->
</head>
<body>
    <div class="container-fluid">
        <div class="row flex-nowrap">
            <!-- Sidebar Navigation -->
            <nav class="col-lg-2 col-md-3 d-md-block sidebar collapse" id="sidebar">
                <div class="position-sticky pt-3">
                    <div class="sidebar-header">
                        <div class="sidebar-title">SG Library</div> <!-- Library branding -->
                    </div>
                    <div class="divider"></div>
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <!-- Active state based on current page -->
                            <a href="{{ url_for('books') }}" class="nav-link {% if request.endpoint == 'books' %}active{% endif %}" data-bs-toggle="collapse" data-bs-target="#sidebar">
                                <i class="fas fa-id-card me-2"></i> 
                                Book Titles
                            </a>
                        </li>
                        {% block sidebar_links %}{% endblock %} <!-- Block for additional sidebar links -->
                    </ul>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="col-lg-10 col-md-9 ms-sm-auto px-4" id="main-content">
                <div class="main-content-wrapper">
                    <!-- Top Navigation Bar -->
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom" id="top-nav">
                        <div class="btn-toolbar mb-0">
                            {% block top_nav_buttons %}{% endblock %} <!-- Block for top navigation buttons -->
                        </div>
                        <h1 class="h2 mb-0 text-left flex-grow-1">{% block page_title %}{% endblock %}</h1> <!-- Page title -->
                        <!-- Mobile sidebar toggle button -->
                        <button class="navbar-toggler d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation" id="sidebar-toggle">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>
                    
                    <div class="container-fluid">
                        <!-- Flash messages display -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        {% block content %}{% endblock %} <!-- Main content block -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- JavaScript libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebar-toggle');
            const mainContentWrapper = document.querySelector('.main-content-wrapper');
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            
            // Initialize Bootstrap Collapse for sidebar
            const bsCollapse = new bootstrap.Collapse(sidebar, {
                toggle: false
            });
            
            // Ensure sidebar starts hidden on mobile devices
            function initializeSidebar() {
                if (window.innerWidth < 768) {
                    bsCollapse.hide();
                    document.body.classList.remove('sidebar-open');
                    if (mainContentWrapper) {
                        mainContentWrapper.classList.remove('pushed-down');
                    }
                } else {
                    sidebar.classList.remove('show');
                    document.body.classList.remove('sidebar-open');
                    if (mainContentWrapper) {
                        mainContentWrapper.classList.remove('pushed-down');
                    }
                }
            }
            
            // Initialize sidebar on page load
            initializeSidebar();
            
            // Handle sidebar show event - adjust layout when sidebar opens
            sidebar.addEventListener('show.bs.collapse', function() {
                document.body.classList.add('sidebar-open');
                if (window.innerWidth < 768 && mainContentWrapper) {
                    mainContentWrapper.classList.add('pushed-down');
                }
            });
            
            // Handle sidebar hide event - restore layout when sidebar closes
            sidebar.addEventListener('hide.bs.collapse', function() {
                document.body.classList.remove('sidebar-open');
                if (mainContentWrapper) {
                    mainContentWrapper.classList.remove('pushed-down');
                }
            });
            
            // Close sidebar when clicking outside (mobile only)
            document.addEventListener('click', function(e) {
                if (window.innerWidth < 768 && sidebar.classList.contains('show')) {
                    if (!sidebar.contains(e.target) && !toggleButton.contains(e.target)) {
                        bsCollapse.hide();
                    }
                }
            });
            
            // Close sidebar on ESC key press
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && sidebar.classList.contains('show')) {
                    bsCollapse.hide();
                }
            });
            
            // Handle window resize events
            window.addEventListener('resize', function() {
                initializeSidebar();
            });
            
            // Handle orientation change on mobile devices
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    initializeSidebar();
                    updateSidebarHeight();
                }, 300);
            });
            
            // Dynamic sidebar height calculation for mobile responsive design
            function updateSidebarHeight() {
                if (window.innerWidth < 768 && sidebar) {
                    const wasVisible = sidebar.classList.contains('show');
                    
                    if (!wasVisible) {
                        sidebar.style.visibility = 'hidden';
                        sidebar.classList.add('show');
                    }
                    
                    const sidebarHeight = sidebar.offsetHeight;
                    document.documentElement.style.setProperty('--sidebar-height', sidebarHeight + 'px');
                    
                    if (!wasVisible) {
                        sidebar.classList.remove('show');
                        sidebar.style.visibility = '';
                    }
                }
            }
            
            // Update sidebar height on initial load
            updateSidebarHeight();
            
            // Debounced resize handler for sidebar height updates
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(updateSidebarHeight, 150);
            });
        });
    </script>
    
    {% block scripts %}{% endblock %} <!-- Block for page-specific scripts -->
</body>
</html>